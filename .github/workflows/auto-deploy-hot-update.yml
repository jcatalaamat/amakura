name: Auto Deploy Hot Update

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy-hot-update:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: 'package.json'

      - name: Install dependencies
        run: bun install

      - name: Deploy iOS
        run: bunx hot-updater deploy --platform ios --channel production-pre
        env:
          METRO_RESET_CACHE: 'true'
          HOT_UPDATER_SUPABASE_URL: ${{ secrets.HOT_UPDATER_SUPABASE_URL }}
          HOT_UPDATER_SUPABASE_ANON_KEY: ${{ secrets.HOT_UPDATER_SUPABASE_ANON_KEY }}
          HOT_UPDATER_SUPABASE_BUCKET_NAME: ${{ secrets.HOT_UPDATER_SUPABASE_BUCKET_NAME }}

      - name: Deploy Android
        run: bunx hot-updater deploy --platform android --channel production-pre
        env:
          METRO_RESET_CACHE: 'true'
          HOT_UPDATER_SUPABASE_URL: ${{ secrets.HOT_UPDATER_SUPABASE_URL }}
          HOT_UPDATER_SUPABASE_ANON_KEY: ${{ secrets.HOT_UPDATER_SUPABASE_ANON_KEY }}
          HOT_UPDATER_SUPABASE_BUCKET_NAME: ${{ secrets.HOT_UPDATER_SUPABASE_BUCKET_NAME }}

      - name: Summary
        if: success()
        run: |
          echo "### Hot Update Auto-Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployed after successful CI run" >> $GITHUB_STEP_SUMMARY
          echo "- Platform: both (iOS + Android)" >> $GITHUB_STEP_SUMMARY
          echo "- Channel: production-pre" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: ${{ github.event.workflow_run.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
