name: CI

on:
  push:
    branches:
      - '**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  build-test-and-deploy:
    if: "!contains(github.event.head_commit.message, 'docs:')"
    timeout-minutes: 25
    # Using Warp runners for ARM64 support (cheaper and faster than GitHub ARM runners)
    # If you don't have Warp, either:
    # 1. Sign up at https://www.warpbuild.com (recommended - cheaper than GitHub)
    # 2. Use GitHub's ubuntu-24.04-arm (requires paid GitHub plan)
    # 3. Use ubuntu-latest and change Docker builds to linux/amd64 in scripts/web/build-docker.ts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-1

      - name: Install
        uses: ./.github/actions/install

      - name: Setup Origin CA Certs
        if: github.ref == 'refs/heads/main'
        run: |
          if [ -n "$ORIGIN_CA_CERT_B64" ] && [ -n "$ORIGIN_CA_KEY_B64" ]; then
            mkdir -p src/uncloud/certs
            echo "$ORIGIN_CA_CERT_B64" | base64 -d > src/uncloud/certs/origin.pem
            echo "$ORIGIN_CA_KEY_B64" | base64 -d > src/uncloud/certs/origin.key
            chmod 600 src/uncloud/certs/origin.key
            echo "ORIGIN_CA_CERT=src/uncloud/certs/origin.pem" >> $GITHUB_ENV
            echo "ORIGIN_CA_KEY=src/uncloud/certs/origin.key" >> $GITHUB_ENV
            echo "âœ“ Origin CA certificates configured"
          else
            echo "âš  Origin CA secrets not configured, will use Let's Encrypt"
          fi
        env:
          ORIGIN_CA_CERT_B64: ${{ secrets.ORIGIN_CA_CERT_B64 }}
          ORIGIN_CA_KEY_B64: ${{ secrets.ORIGIN_CA_KEY_B64 }}

      - name: CI/CD
        run: bun ops release ${{ github.ref != 'refs/heads/main' && '--skip-deploy' || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # origin ca certs for cloudflare ssl (base64 encoded)
          ORIGIN_CA_CERT_B64: ${{ secrets.ORIGIN_CA_CERT_B64 }}
          ORIGIN_CA_KEY_B64: ${{ secrets.ORIGIN_CA_KEY_B64 }}
          # ðŸ”’ start - this is generated by "bun env:update"
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          APNS_ENDPOINT: ${{ secrets.APNS_ENDPOINT }}
          APNS_TEAM_ID: ${{ secrets.APNS_TEAM_ID }}
          APNS_KEY_ID: ${{ secrets.APNS_KEY_ID }}
          APNS_KEY: ${{ secrets.APNS_KEY }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
          BETTER_AUTH_URL: ${{ secrets.BETTER_AUTH_URL }}
          CLOUDFLARE_R2_ACCESS_KEY: ${{ secrets.CLOUDFLARE_R2_ACCESS_KEY }}
          CLOUDFLARE_R2_ENDPOINT: ${{ secrets.CLOUDFLARE_R2_ENDPOINT }}
          CLOUDFLARE_R2_PUBLIC_URL: ${{ secrets.CLOUDFLARE_R2_PUBLIC_URL }}
          CLOUDFLARE_R2_SECRET_KEY: ${{ secrets.CLOUDFLARE_R2_SECRET_KEY }}
          DEPLOYMENT_PLATFORM: ${{ secrets.DEPLOYMENT_PLATFORM }}
          DEPLOYMENT_ARCH: ${{ secrets.DEPLOYMENT_ARCH }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_DB: ${{ secrets.DEPLOY_DB }}
          ONE_SERVER_URL: ${{ secrets.ONE_SERVER_URL }}
          POSTMARK_SERVER_TOKEN: ${{ secrets.POSTMARK_SERVER_TOKEN }}
          VITE_DEMO_MODE: ${{ secrets.VITE_DEMO_MODE }}
          VITE_POSTHOG_API_KEY: ${{ secrets.VITE_POSTHOG_API_KEY }}
          VITE_POSTHOG_HOST: ${{ secrets.VITE_POSTHOG_HOST }}
          VITE_ZERO_HOST: ${{ secrets.VITE_ZERO_HOST }}
          VITE_WEB_HOST: ${{ secrets.VITE_WEB_HOST }}
          ZERO_NUM_SYNC_WORKERS: ${{ secrets.ZERO_NUM_SYNC_WORKERS }}
          ZERO_CVR_MAX_CONNS: ${{ secrets.ZERO_CVR_MAX_CONNS }}
          ZERO_UPSTREAM_MAX_CONNS: ${{ secrets.ZERO_UPSTREAM_MAX_CONNS }}
          ZERO_PER_USER_MUTATION_LIMIT_MAX: ${{ secrets.ZERO_PER_USER_MUTATION_LIMIT_MAX }}
          ZERO_PER_USER_MUTATION_LIMIT_WINDOW_MS: ${{ secrets.ZERO_PER_USER_MUTATION_LIMIT_WINDOW_MS }}
          ZERO_MUTATE_FORWARD_COOKIES: ${{ secrets.ZERO_MUTATE_FORWARD_COOKIES }}
          ZERO_QUERY_FORWARD_COOKIES: ${{ secrets.ZERO_QUERY_FORWARD_COOKIES }}
          ZERO_APP_PUBLICATIONS: ${{ secrets.ZERO_APP_PUBLICATIONS }}
          ZERO_VERSION: ${{ secrets.ZERO_VERSION || '0.25.12' }}
          # ðŸ”’ end - this is generated by "bun env:update"
