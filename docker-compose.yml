services:
  pgdb:
    image: pgvector/pgvector:pg16
    shm_size: 1g
    restart: always
    healthcheck:
      test: 'pg_isready -U user --dbname=postgres'
      interval: 1s
      timeout: 5s
      retries: 10
    ports:
      - "${VITE_PORT_POSTGRES:-5433}:5432"
    environment:
      POSTGRES_USER: user
      POSTGRES_DB: postgres
      POSTGRES_PASSWORD: password
    command: |
      postgres
      -c wal_level=logical
      -c max_wal_senders=10
      -c max_replication_slots=5
      -c hot_standby=on
      -c max_connections=256
    # for verbose logging when debugging (uncomment as needed):
      # -c log_error_verbosity=default
      # -c log_min_messages=info
      # -c log_statement=all
      # -c log_connections=on
      # -c log_disconnections=on
      # -c log_duration=on
      # -c log_line_prefix='%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
    volumes:
      - ./.docker/pgdb:/var/lib/postgresql/data
      - ./src/database/:/docker-entrypoint-initdb.d

  migrate:
    image: node:22.4-slim
    depends_on:
      pgdb:
        condition: service_healthy
    volumes:
      - .:/app
    working_dir: /app/src/database
    environment:
      - RUN=1
      - ALLOW_MISSING_ENV=1
      - ZERO_UPSTREAM_DB=postgresql://user:password@pgdb:5432/postgres
      - ZERO_CVR_DB=postgresql://user:password@pgdb:5432/zero_cvr
      - ZERO_CHANGE_DB=postgresql://user:password@pgdb:5432/zero_cdb
    command: node migrate-dist.js

  zero:
    image: "rocicorp/zero:${ZERO_VERSION:-error-run-bun-tko-run-generate-env}"
    depends_on:
      migrate:
        condition: service_completed_successfully
      pgdb:
        condition: service_healthy
    env_file: .env
    volumes:
      - ./.docker/zero:/app
    working_dir: /app
    extra_hosts:
      # maps host.docker.internal to the host gateway IP on Linux
      # on Mac/Windows Docker Desktop, this is already available
      - "host.docker.internal:host-gateway"
    environment:
      # docker-internal overrides (DB URLs use container hostnames, not localhost)
      - ZERO_UPSTREAM_DB=postgresql://user:password@pgdb:5432/postgres
      - ZERO_CVR_DB=postgresql://user:password@pgdb:5432/zero_cvr
      - ZERO_CHANGE_DB=postgresql://user:password@pgdb:5432/zero_cdb
      # push/pull URLs point to host dev server (not available in .env)
      - ZERO_MUTATE_URL=http://host.docker.internal:8081/api/zero/push
      - ZERO_QUERY_URL=http://host.docker.internal:8081/api/zero/pull
      - ZERO_ADMIN_PASSWORD=dev
    ports:
      - "${VITE_PORT_ZERO:-4848}:4848"

  minio:
    image: minio/minio
    restart: always
    entrypoint: sh
    # create the 'chat' bucket before starting the service
    command: -c 'mkdir -p /data/chat && minio server --address ":9000" --console-address ":9001" /data'
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio_password
    ports:
      - "${VITE_PORT_MINIO:-9200}:9000"
      - "${VITE_PORT_MINIO_CONSOLE:-9201}:9001"
    volumes:
      - ./.docker/minio:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 1s
      timeout: 5s
      retries: 5
      start_period: 1s

  minio-init:
    image: minio/mc
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
        until mc alias set local http://minio:9000 minio minio_password; do
          echo 'Waiting for MinIO...';
          sleep 1;
        done &&
        mc mb --ignore-existing local/chat &&
        mc anonymous set download local/chat &&
        echo 'âœ… MinIO chat bucket ready and public';
      "
